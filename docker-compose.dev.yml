# Lightweight dev setup: kodosumi + ray only (SQLite defaults)
# Usage: docker compose -f docker-compose.dev.yml up
#
# Mounts local code for live reload. No PostgreSQL, Redis, or Temporal.

services:

  ray-head:
    image: rayproject/ray:2.41.0-py311
    ports:
      - "6379:6379"
      - "8265:8265"
    command: >
      ray start --head
      --port=6379
      --dashboard-host=0.0.0.0
      --dashboard-port=8265
      --block
    healthcheck:
      test: ["CMD", "ray", "status"]
      interval: 10s
      timeout: 5s
      retries: 5

  panel:
    build: .
    ports:
      - "3370:3370"
    environment:
      KODO_APP_SERVER: "http://0.0.0.0:3370"
      KODO_RAY_SERVER: "ray-head:6379"
      KODO_APP_RELOAD: "true"
    volumes:
      - ./kodosumi:/app/kodosumi
      - ./data:/app/data
    depends_on:
      ray-head:
        condition: service_healthy
    command: ["koco", "serve", "--address", "http://0.0.0.0:3370"]

  spooler:
    build: .
    environment:
      KODO_RAY_SERVER: "ray-head:6379"
    volumes:
      - ./kodosumi:/app/kodosumi
      - ./data:/app/data
    depends_on:
      ray-head:
        condition: service_healthy
    command: ["koco", "spool", "--block"]
