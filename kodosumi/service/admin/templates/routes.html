{% extends "_frame.html" %}

{% block styles %}
    .audit-console {
        background: #1a1a1a;
        border-radius: 8px;
        padding: 16px;
        height: 300px;
        overflow-y: auto;
        font-family: 'Fira Code', 'Monaco', 'Menlo', monospace;
        font-size: 0.8rem;
        line-height: 1.5;
    }
    .audit-line {
        margin: 0;
        padding: 2px 0;
        white-space: pre-wrap;
        word-break: break-word;
        color: #e0e0e0;
    }
    .audit-line.info { color: #81c784; }
    .audit-line.warning { color: #ffb74d; }
    .audit-line.error { color: #ef5350; }
    .audit-controls {
        display: flex;
        gap: 12px;
        margin-bottom: 12px;
        align-items: center;
    }
    .audit-status {
        font-size: 0.85rem;
        color: var(--on-surface-variant);
        margin-left: auto;
    }
{% endblock %}

{% block menu %}
<h3>Agentic Control</h3>
<div class="max"></div>
<div class="tabs right-align" style="height: 50px;">
</div>
{% endblock %}

{% block details %}
{% endblock %}

{% block page %}
<div class="active page">
    <article id="article-output" class="max margin small-elevate large-padding article-container">
        <h5>Routes</h5>
        <p>
            The following agentic nodes have been registered. <br/>
            The endpoints either address an <code>/openapi.json</code> endpoint 
            or a <span class="italic">Ray</span><code>/-/routes</code> endpoint.
        </p>
        <form method="POST">
            <div class="field textarea border extra">
                <textarea name="routes">{{ items | join("\n") }}</textarea>
            </div>
            {% if routes %}
            <h5 class="small">Reconnected Service Routes:</h5>
            {% if message %}
            <p class="primary-container no-round bold padding">
                {{ message["routes"] | join("<br/>") | safe}}
            </p>
            {% endif %}
            <div class="space"></div>
            {% for route in routes %}
            <details>
                <summary>
                    <i class="small">expand_content</i>
                    <bold>
                        {{ route }}
                    </bold>
                </summary>
                <p><article><pre style="font-family: monospace; white-space: pre-wrap;">{{ routes[route] | tojson(indent=2) }}</article></pre></p>
            </details>
            {% endfor %}
            <div class="space"></div>
            {% endif %}
            <button class="secondary" name="refresh" type="submit" {% if not user.operator %}disabled{% endif %}>Reconnect</button>
        </form>
        <div class="space"></div>
        <div class="large-divider"></div>
        <h5>Settings</h5>
        {% if message %}
        {% if message["settings"] %}
        <p class="primary-container no-round bold padding">
            {{ message["settings"] | join("<br/>") | safe}}
        </p>
        <div class="space"></div>
        {% endif %}
        {% endif %}
        <form method="POST">
            <div class="field border label large">
                <input type="text" name="name" value="{{user.name}}" readonly/>
                <label>Username</label>
            </div>
            <div class="field border label large">
                <input type="password" name="new_password1"/>
                <label>New Password</label>
            </div>
            <div class="field border label large">
                <input type="password" name="new_password2"/>
                <label>Repeat New Password</label>
            </div>
            <div class="field border label large">
                <input type="email" name="email" value="{{user.email}}"/>
                <label>E-Mail</label>
            </div>
            <button class="secondary" name="update"type="submit">Update</button>
        </form>
        <div class="space"></div>
        <div class="large-divider"></div>
        <h5>Help</h5>
        <ul>
            <li><a target="_blank" href="/schema/swagger">Swagger UI</a></li>
            <li><a target="_blank" href="/schema/openapi.json">OpenAPI Schema</a></li>
        </ul>
        <div class="space"></div>
        <div class="large-divider"></div>
        <h5>Audit Log</h5>
        <p>Boot and deployment events. INFO level only (no sensitive details).</p>
        <div class="audit-controls">
            <button class="secondary small" id="audit-refresh" onclick="loadAuditLog()">
                <i>refresh</i>
                <span>Refresh</span>
            </button>
            <button class="secondary small" id="audit-follow" onclick="toggleFollow()">
                <i>play_arrow</i>
                <span>Follow</span>
            </button>
            <button class="secondary small" onclick="clearAuditConsole()">
                <i>delete</i>
                <span>Clear</span>
            </button>
            <span class="audit-status" id="audit-status">Ready</span>
        </div>
        <div class="audit-console" id="audit-console">
            <p class="audit-line" style="color: #9e9e9e;">Click "Refresh" to load audit log or "Follow" to stream updates.</p>
        </div>
        <div class="space"></div>
        <div class="large-divider"></div>
        <h5>Status Information</h5>
        <ul>
            <li>Kodosumi Version: {{ kodosumi_version }}</li>
            <li>Ray Version: {{ ray_version }}</li>
            <li>Python Version: {{ python_version }}</li>
            <li>Ray Status: 
                <ul>
                    {% for node in ray_status %}
                    <li>
                        {{ node["NodeName"]}} ({{ node["NodeID"]}}) - {% if node["Alive"] %}Alive{% else %}Dead{% endif %}
                    </li>
                    {% endfor %}
                </ul>
            </li>
            <li>
                Spooler Status: 
                <ul>
                    {% if spooler_status["error"] %}
                    <li>
                        <b>error:</b> {{ spooler_status["error"] }}
                    </li>
                    {% else %}
                    <li>
                        <b>pid:</b> {{ spooler_status["pid"] }}
                    </li>
                    <li>
                        <b>active executions:</b> {{ spooler_status["active"] }}
                    </li>
                    <li>
                        <b>done executions:</b> {{ spooler_status["total"] }}
                    </li>
                    {% endif %}
                </ul>
        </ul>
        <div class="large-divider"></div>
    </article>
</div>
{% endblock %}

{% block script %}
// Audit Log functionality
let auditOffset = 0;
let auditFollowing = false;
let auditFollowInterval = null;

// Elements - initialized after DOM loads
let auditConsole, auditStatus, auditFollowBtn;

function initAuditElements() {
    auditConsole = document.getElementById('audit-console');
    auditStatus = document.getElementById('audit-status');
    auditFollowBtn = document.getElementById('audit-follow');
}

function appendAuditLine(text) {
    if (!auditConsole) initAuditElements();
    const line = document.createElement('p');
    line.className = 'audit-line';

    // Apply styling based on log level
    if (text.includes(' INFO ')) {
        line.classList.add('info');
    } else if (text.includes(' WARNING ')) {
        line.classList.add('warning');
    } else if (text.includes(' ERROR ')) {
        line.classList.add('error');
    }

    line.textContent = text;
    auditConsole.appendChild(line);
    auditConsole.scrollTop = auditConsole.scrollHeight;
}

async function loadAuditLog(append = false) {
    if (!auditConsole) initAuditElements();
    try {
        if (!append) {
            auditConsole.innerHTML = '';
            auditOffset = 0;
        }

        auditStatus.textContent = 'Loading...';

        const response = await fetch(`/audit/stream?offset=${auditOffset}&limit=200`, {
            credentials: 'same-origin'
        });

        if (!response.ok) {
            const errorText = await response.text();
            auditStatus.textContent = 'Error: ' + response.status;
            appendAuditLine(`Error ${response.status}: ${errorText}`);
            return;
        }

        const data = await response.json();

        if (data.lines && data.lines.length > 0) {
            for (const line of data.lines) {
                appendAuditLine(line);
            }
        } else if (!append) {
            appendAuditLine('No audit log entries found.');
        }

        auditOffset = data.next_offset;
        const sizeKB = (data.file_size / 1024).toFixed(1);
        auditStatus.textContent = `${data.lines.length} lines | ${sizeKB} KB | offset: ${auditOffset}`;

    } catch (error) {
        auditStatus.textContent = 'Error: ' + error.message;
    }
}

function toggleFollow() {
    if (!auditFollowBtn) initAuditElements();
    auditFollowing = !auditFollowing;

    if (auditFollowing) {
        auditFollowBtn.innerHTML = '<i>pause</i><span>Pause</span>';
        auditFollowBtn.classList.add('primary');
        auditFollowBtn.classList.remove('secondary');

        // Start polling for new lines
        loadAuditLog(true);
        auditFollowInterval = setInterval(() => loadAuditLog(true), 2000);
    } else {
        auditFollowBtn.innerHTML = '<i>play_arrow</i><span>Follow</span>';
        auditFollowBtn.classList.add('secondary');
        auditFollowBtn.classList.remove('primary');

        if (auditFollowInterval) {
            clearInterval(auditFollowInterval);
            auditFollowInterval = null;
        }
        auditStatus.textContent = 'Paused';
    }
}

function clearAuditConsole() {
    if (!auditConsole) initAuditElements();
    auditConsole.innerHTML = '<p class="audit-line" style="color: #9e9e9e;">Console cleared.</p>';
    auditOffset = 0;
    auditStatus.textContent = 'Cleared';
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    initAuditElements();
});
{% endblock %}
